generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model Users {
  id                   String                 @id @default(cuid())
  name                 String?
  username             String?                @unique
  email                String                 @unique
  password_hash        String?
  google_id            String?                @unique
  github_id            String?                @unique
  avatar_url           String?
  bio                  String?
  role                 UserRole               @default(user)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  activity_logs        ActivityLogs[]
  comments             Comments[]
  features             Features[]
  followers            Followers[]
  notifications        Notifications[]
  sent_invites         ProjectInvites[]       @relation("Inviter")
  memberships          ProjectMembers[]
  owned_projects       Projects[]             @relation("ProjectOwner")
  votes                Votes[]
  discussionLikes      DiscussionLikes[]
  discussionReplies    DiscussionReplies[]
  discussionReplyLikes DiscussionReplyLikes[]
  discussions          Discussions[]
}

model Projects {
  id            String           @id @default(cuid())
  title         String
  description   String?
  category      String?
  logo_url      String?
  visibility    Visibility       @default(public)
  slug          String           @unique
  owner_id      String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  progress      Int              @default(0)
  activity_logs ActivityLogs[]
  features      Features[]
  followers     Followers[]
  invites       ProjectInvites[]
  members       ProjectMembers[]
  owner         Users            @relation("ProjectOwner", fields: [owner_id], references: [id])
  stages        RoadmapStages[]
  discussions   Discussions[]
}

model RoadmapStages {
  id         String     @id @default(cuid())
  title      String
  position   Int
  project_id String
  createdAt  DateTime   @default(now())
  color      String?    @default("bg-gray-500")
  features   Features[]
  project    Projects   @relation(fields: [project_id], references: [id])
}

model Features {
  id          String         @id @default(cuid())
  title       String
  description String?
  tags        String[]
  status      FeatureStatus  @default(open)
  priority    Priority       @default(medium)
  vote_count  Int            @default(0)
  project_id  String
  stage_id    String?
  author_id   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  progress    Int            @default(0)
  start_date  DateTime?
  target_date DateTime?
  comments    Comments[]
  author      Users          @relation(fields: [author_id], references: [id])
  project     Projects       @relation(fields: [project_id], references: [id])
  stage       RoadmapStages? @relation(fields: [stage_id], references: [id])
  votes       Votes[]
}

model Votes {
  id         String   @id @default(cuid())
  value      Int
  user_id    String
  feature_id String
  createdAt  DateTime @default(now())
  feature    Features @relation(fields: [feature_id], references: [id])
  user       Users    @relation(fields: [user_id], references: [id])

  @@unique([user_id, feature_id])
}

model Comments {
  id         String     @id @default(cuid())
  content    String
  parent_id  String?
  author_id  String
  feature_id String
  createdAt  DateTime   @default(now())
  author     Users      @relation(fields: [author_id], references: [id])
  feature    Features   @relation(fields: [feature_id], references: [id])
  parent     Comments?  @relation("CommentReplies", fields: [parent_id], references: [id])
  replies    Comments[] @relation("CommentReplies")
}

model ProjectMembers {
  id         String      @id @default(cuid())
  role       ProjectRole @default(viewer)
  user_id    String
  project_id String
  joinedAt   DateTime    @default(now())
  project    Projects    @relation(fields: [project_id], references: [id])
  user       Users       @relation(fields: [user_id], references: [id])

  @@unique([user_id, project_id])
}

model Followers {
  id         String   @id @default(cuid())
  user_id    String
  project_id String
  createdAt  DateTime @default(now())
  project    Projects @relation(fields: [project_id], references: [id])
  user       Users    @relation(fields: [user_id], references: [id])

  @@unique([user_id, project_id])
}

model Notifications {
  id           String           @id @default(cuid())
  type         NotificationType
  user_id      String
  reference_id String?
  message      String?
  read         Boolean          @default(false)
  createdAt    DateTime         @default(now())
  user         Users            @relation(fields: [user_id], references: [id])
}

model ActivityLogs {
  id         String    @id @default(cuid())
  action     String
  metadata   Json?
  user_id    String
  project_id String?
  createdAt  DateTime  @default(now())
  project    Projects? @relation(fields: [project_id], references: [id])
  user       Users     @relation(fields: [user_id], references: [id])
}

model ProjectInvites {
  id          String      @id @default(cuid())
  token       String      @unique
  email       String
  role        ProjectRole @default(viewer)
  accepted    Boolean     @default(false)
  expires_at  DateTime
  project_id  String
  invited_by  String
  accepted_at DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inviter     Users       @relation("Inviter", fields: [invited_by], references: [id])
  project     Projects    @relation(fields: [project_id], references: [id])

  @@index([token])
  @@index([email])
}

model Discussions {
  id         String              @id @default(cuid())
  content    String
  author_id  String
  project_id String
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  likes      DiscussionLikes[]
  replies    DiscussionReplies[]
  author     Users               @relation(fields: [author_id], references: [id], onDelete: Cascade)
  project    Projects            @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@map("discussions")
}

model DiscussionReplies {
  id            String                 @id @default(cuid())
  content       String
  author_id     String
  discussion_id String
  parent_id     String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  author        Users                  @relation(fields: [author_id], references: [id], onDelete: Cascade)
  discussion    Discussions            @relation(fields: [discussion_id], references: [id], onDelete: Cascade)
  parent        DiscussionReplies?     @relation("DiscussionReplyReplies", fields: [parent_id], references: [id])
  replies       DiscussionReplies[]    @relation("DiscussionReplyReplies")
  likes         DiscussionReplyLikes[]

  @@map("discussion_replies")
}

model DiscussionReplyLikes {
  id        String            @id @default(cuid())
  user_id   String
  reply_id  String
  createdAt DateTime          @default(now())
  reply     DiscussionReplies @relation(fields: [reply_id], references: [id], onDelete: Cascade)
  user      Users             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, reply_id])
  @@map("discussion_reply_likes")
}

model DiscussionLikes {
  id            String      @id @default(cuid())
  user_id       String
  discussion_id String
  createdAt     DateTime    @default(now())
  discussion    Discussions @relation(fields: [discussion_id], references: [id], onDelete: Cascade)
  user          Users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, discussion_id])
  @@map("discussion_likes")
}

enum UserRole {
  user
  admin
  superadmin
}

enum Visibility {
  public
  private
}

enum FeatureStatus {
  open
  under_review
  in_progress
  completed
  rejected
}

enum Priority {
  low
  medium
  high
}

enum ProjectRole {
  owner
  admin
  editor
  viewer
  member
}

enum NotificationType {
  comment
  status_update
  new_feature
  vote
  mention
}
